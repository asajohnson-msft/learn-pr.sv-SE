<span data-ttu-id="a38ae-101">Justeringar i serverkonfigurationen utförs ofta med utrustning i din lokala miljö.</span><span class="sxs-lookup"><span data-stu-id="a38ae-101">Making adjustments to server configuration is commonly performed with equipment in your on-premises environment.</span></span> <span data-ttu-id="a38ae-102">I det avseendet kan du se virtuella Azure-datorer som en förlängning av den här miljön.</span><span class="sxs-lookup"><span data-stu-id="a38ae-102">In this sense, you can consider Azure VMs to be an extension of that environment.</span></span> <span data-ttu-id="a38ae-103">Du kan ändra konfiguration, hantera nätverk, öppna eller blockera trafik med mera via Azure Portal, Azure CLI eller Azure PowerShell-verktyg.</span><span class="sxs-lookup"><span data-stu-id="a38ae-103">You can alter configuration, manage networks, open or block traffic, and more through the Azure portal, Azure CLI, or Azure PowerShell tools.</span></span>

<span data-ttu-id="a38ae-104">Vår server körs och Apache har installerats och används av sidor.</span><span class="sxs-lookup"><span data-stu-id="a38ae-104">We've got our server running, and Apache is installed and serving up pages.</span></span> <span data-ttu-id="a38ae-105">Vårt säkerhetsteam uppmanar oss att låsa alla servrar och vi har inte gjort något åt den här virtuella datorn än.</span><span class="sxs-lookup"><span data-stu-id="a38ae-105">Our security team mandates that we lock down all our servers and we've not done anything to this VM yet.</span></span> <span data-ttu-id="a38ae-106">Vi har inte gjort något och Apache lyssnar på port 80.</span><span class="sxs-lookup"><span data-stu-id="a38ae-106">We didn't do anything, and it let Apache listen on port 80.</span></span> <span data-ttu-id="a38ae-107">Låt oss utforska Azure-nätverkskonfigurationen för att se hur säkerhetssupport kan användas för att förstärka servern.</span><span class="sxs-lookup"><span data-stu-id="a38ae-107">Let's explore the Azure network configuration to see how to use the built-in security support to harden our server.</span></span>

## <a name="opening-ports-in-azure-vms"></a><span data-ttu-id="a38ae-108">Öppna portar i virtuella Azure-datorer</span><span class="sxs-lookup"><span data-stu-id="a38ae-108">Opening ports in Azure VMs</span></span>

<!-- TODO: Azure portal is inconsistent here in applying the NSG.
By default, new VMs are locked down. 

Apps can make outgoing requests, but the only inbound traffic allowed is from the virtual network (e.g., other resources on the same local network), and from Azure's Load Balancer (probe checks). -->

<span data-ttu-id="a38ae-109">Det finns två steg för att justera konfigurationen för att stödja olika protokoll i nätverket.</span><span class="sxs-lookup"><span data-stu-id="a38ae-109">There are two steps to adjusting the configuration to support different protocols on the network.</span></span> <span data-ttu-id="a38ae-110">När du skapar en ny virtuell dator har du möjlighet att öppna några vanliga portar (RDP, HTTP, HTTPS och SSH).</span><span class="sxs-lookup"><span data-stu-id="a38ae-110">When you create a new VM, you have an opportunity to open a few common ports (RDP, HTTP, HTTPS, and SSH).</span></span> <span data-ttu-id="a38ae-111">Men om du behöver andra ändringar av brandväggen måste du justera dem manuellt.</span><span class="sxs-lookup"><span data-stu-id="a38ae-111">However, if you require other changes to the firewall, you will need to adjust them manually.</span></span>

<span data-ttu-id="a38ae-112">Processen för det här omfattar två steg:</span><span class="sxs-lookup"><span data-stu-id="a38ae-112">The process for this involves two steps:</span></span>

1. <span data-ttu-id="a38ae-113">Skapa en nätverkssäkerhetsgrupp</span><span class="sxs-lookup"><span data-stu-id="a38ae-113">Create a Network Security Group</span></span>

1. <span data-ttu-id="a38ae-114">Skapa en inkommande regel som tillåter trafik på portarna som du behöver</span><span class="sxs-lookup"><span data-stu-id="a38ae-114">Create an inbound rule allowing traffic on the ports you need</span></span>

### <a name="what-is-a-network-security-group"></a><span data-ttu-id="a38ae-115">Vad är en nätverkssäkerhetsgrupp?</span><span class="sxs-lookup"><span data-stu-id="a38ae-115">What is a Network Security Group?</span></span>

<span data-ttu-id="a38ae-116">Virtuella nätverk är grunden för Azure-nätverksmodellen och ger isolering och skydd.</span><span class="sxs-lookup"><span data-stu-id="a38ae-116">Virtual networks (VNets) are the foundation of the Azure networking model and provide isolation and protection.</span></span> <span data-ttu-id="a38ae-117">Nätverkssäkerhetsgrupper (NSG) är det primära verktyget för att tillämpa och styra regler för nätverkstrafik på nätverksnivå.</span><span class="sxs-lookup"><span data-stu-id="a38ae-117">Network Security Groups (NSGs) are the primary tool you use to enforce and control network traffic rules at the networking level.</span></span> <span data-ttu-id="a38ae-118">NSG:er är ett valfritt säkerhetslager som tillhandahåller en programvarubrandvägg genom att filtrera inkommande och utgående trafik på det virtuella nätverket.</span><span class="sxs-lookup"><span data-stu-id="a38ae-118">NSGs are an optional security layer that provides a software firewall by filtering inbound and outbound traffic on the VNet.</span></span> 

<span data-ttu-id="a38ae-119">Säkerhetsgrupper kan kopplas till ett nätverksgränssnitt (för regler per värd), ett undernät i det virtuella nätverket (om du vill tillämpa på flera resurser) eller båda nivåerna.</span><span class="sxs-lookup"><span data-stu-id="a38ae-119">Security groups can be associated to a network interface (for per-host rules), a subnet in the virtual network (to apply to multiple resources), or both levels.</span></span> 

#### <a name="security-group-rules"></a><span data-ttu-id="a38ae-120">Regler för säkerhetsgrupper</span><span class="sxs-lookup"><span data-stu-id="a38ae-120">Security group rules</span></span>

<span data-ttu-id="a38ae-121">NGS:er använder _regler_ för att tillåta eller neka trafik genom nätverket.</span><span class="sxs-lookup"><span data-stu-id="a38ae-121">NGSs use _rules_ to allow or deny traffic moving through the network.</span></span> <span data-ttu-id="a38ae-122">Varje regel identifierar käll- och måladress (eller intervall), protokoll, port (eller intervall), riktning (inkommande eller utgående), en numerisk prioritet och om trafiken som matchar regeln ska tillåtas eller nekas.</span><span class="sxs-lookup"><span data-stu-id="a38ae-122">Each rule identifies the source and destination address (or range), protocol, port (or range), direction (inbound or outbound), a numeric priority, and whether to allow or deny the traffic that matches the rule.</span></span> <span data-ttu-id="a38ae-123">Följande bild visar NSG-regler som tillämpas på nivåerna för undernät och gränssnitt.</span><span class="sxs-lookup"><span data-stu-id="a38ae-123">The following illustration shows NSG rules applied at the subnet and network interface levels.</span></span>

![<span data-ttu-id="a38ae-124">En bild som visar nätverkssäkerhetsgrupper arkitektur i två olika undernät.</span><span class="sxs-lookup"><span data-stu-id="a38ae-124">An illustration showing the architecture of network security groups in two different subnets.</span></span> <span data-ttu-id="a38ae-125">Det finns två virtuella datorer i ett undernät, var och en med sina egna regler för gränssnittet.</span><span class="sxs-lookup"><span data-stu-id="a38ae-125">In one subnet, there are two virtual machines, each with their own network interface rules.</span></span>  <span data-ttu-id="a38ae-126">Själva undernätet har en uppsättning regler som gäller för båda de virtuella datorerna.</span><span class="sxs-lookup"><span data-stu-id="a38ae-126">The subnet itself has a set of rules that applies to both the virtual machines.</span></span> ](../media-drafts/7-nsg-rules.png)

<span data-ttu-id="a38ae-127">Varje säkerhetsgrupp har en uppsättning standardsäkerhetsregler för att tillämpa standardnätverksregler som beskrivs ovan.</span><span class="sxs-lookup"><span data-stu-id="a38ae-127">Each security group has a set of default security rules to apply the default network rules described above.</span></span> <span data-ttu-id="a38ae-128">Dessa standardregler kan inte ändras men de _kan_ åsidosättas.</span><span class="sxs-lookup"><span data-stu-id="a38ae-128">These default rules cannot be modified, but _can_ be overridden.</span></span>

#### <a name="how-azure-uses-network-rules"></a><span data-ttu-id="a38ae-129">Så använder Azure nätverksregler</span><span class="sxs-lookup"><span data-stu-id="a38ae-129">How Azure uses network rules</span></span>

<span data-ttu-id="a38ae-130">För inkommande trafik bearbetar Azure den säkerhetsgrupp som kopplas till undernätet och sedan den säkerhetsgrupp som tillämpas på nätverksgränssnittet.</span><span class="sxs-lookup"><span data-stu-id="a38ae-130">For inbound traffic, Azure processes the security group associated to the subnet, and then the security group applied to the network interface.</span></span> <span data-ttu-id="a38ae-131">Utgående trafik hanteras i omvänd ordning (nätverksgränssnittet först, sedan undernätet).</span><span class="sxs-lookup"><span data-stu-id="a38ae-131">Outbound traffic is handled in the opposite order (the network interface first, followed by the subnet).</span></span>

> [!WARNING]
> <span data-ttu-id="a38ae-132">Tänk på att säkerhetsgrupper är valfria på båda nivåerna.</span><span class="sxs-lookup"><span data-stu-id="a38ae-132">Keep in mind that security groups are optional at both levels.</span></span> <span data-ttu-id="a38ae-133">Om ingen säkerhetsgrupp tillämpas **tillåts all trafik** av Azure.</span><span class="sxs-lookup"><span data-stu-id="a38ae-133">If no security group is applied then **all traffic is allowed** by Azure.</span></span> <span data-ttu-id="a38ae-134">Om den virtuella datorn har en offentlig IP-adress kan det vara en allvarlig risk, särskilt om operativsystemet inte har en inbyggd brandvägg.</span><span class="sxs-lookup"><span data-stu-id="a38ae-134">If the VM has a public IP, this could be a serious risk particularly if the OS doesn't provide a built-in firewall.</span></span>

<span data-ttu-id="a38ae-135">Reglerna utvärderas i _prioritetsordning_, från regeln med **lägst prioritet**.</span><span class="sxs-lookup"><span data-stu-id="a38ae-135">The rules are evaluated in _priority-order_, starting with the **lowest priority** rule.</span></span> <span data-ttu-id="a38ae-136">Neka-regler **stoppar** alltid utvärderingen.</span><span class="sxs-lookup"><span data-stu-id="a38ae-136">Deny rules always **stop** the evaluation.</span></span> <span data-ttu-id="a38ae-137">Exempel: Om en regel för nätverksgränssnittet blockerar en utgående begäran kontrolleras inte några regler som tillämpas på undernätet.</span><span class="sxs-lookup"><span data-stu-id="a38ae-137">For example, if a network interface rule blocks an outbound request, any rules applied to the subnet will not be checked.</span></span> <span data-ttu-id="a38ae-138">För att trafik ska tillåtas via säkerhetsgruppen måste den passera genom _alla_ tillämpade grupper.</span><span class="sxs-lookup"><span data-stu-id="a38ae-138">For traffic to be allowed through the security group, it must pass through _all_ applied groups.</span></span>

<span data-ttu-id="a38ae-139">Den sista regeln är alltid **Neka alla**.</span><span class="sxs-lookup"><span data-stu-id="a38ae-139">The last rule is always a **Deny All** rule.</span></span> <span data-ttu-id="a38ae-140">Det här är en standardregel som läggs till i varje säkerhetsgrupp för både inkommande och utgående trafik med prioriteten 65500.</span><span class="sxs-lookup"><span data-stu-id="a38ae-140">This is a default rule added to every security group for both inbound and outbound traffic with a priority of 65500.</span></span> <span data-ttu-id="a38ae-141">Det innebär att för att trafik ska passera genom säkerhetsgruppen _måste du ha en Tillåt-regel_. Annars blockeras den av den sista standardregeln.</span><span class="sxs-lookup"><span data-stu-id="a38ae-141">That means to have traffic pass through the security group _you must have an allow rule_ or the final default rule will block it.</span></span>

> [!NOTE]
> <span data-ttu-id="a38ae-142">SMTP (port 25) är ett specialfall – beroende på din prenumerationsnivå och när ditt konto har skapats kan utgående SMTP-trafik blockeras.</span><span class="sxs-lookup"><span data-stu-id="a38ae-142">SMTP (port 25) is a special case, depending on your subscription level and when your account was created, outbound SMTP traffic may be blocked.</span></span> <span data-ttu-id="a38ae-143">Du kan begära att ta bort begränsningen med affärsrelaterad motivering.</span><span class="sxs-lookup"><span data-stu-id="a38ae-143">You can request to remove this restriction with business justification.</span></span>

<span data-ttu-id="a38ae-144">Eftersom vi inte har skapat en säkerhetsgrupp för den här virtuella datorn ska vi göra det och tillämpa den.</span><span class="sxs-lookup"><span data-stu-id="a38ae-144">Since we didn't create a security group for this VM, let's do that and apply it.</span></span>

## <a name="creating-network-security-groups"></a><span data-ttu-id="a38ae-145">Skapa nätverkssäkerhetsgrupper</span><span class="sxs-lookup"><span data-stu-id="a38ae-145">Creating Network Security Groups</span></span>

<span data-ttu-id="a38ae-146">Säkerhetsgrupper är hanterade resurser som det mesta i Azure. Du kan skapa dem i Azure Portal eller via kommandoradsverktyg för skript.</span><span class="sxs-lookup"><span data-stu-id="a38ae-146">Security groups are managed resources like most everything in Azure; you can create them in the Azure portal or through command-line scripting tools.</span></span> <span data-ttu-id="a38ae-147">Utmaningen är att definiera reglerna.</span><span class="sxs-lookup"><span data-stu-id="a38ae-147">The challenge is in defining the rules.</span></span> <span data-ttu-id="a38ae-148">Låt oss titta på att definierar en ny regel för att tillåta HTTP-åtkomst och blockera allt annat.</span><span class="sxs-lookup"><span data-stu-id="a38ae-148">Let's look at defining a new rule to allow HTTP access and block everything else.</span></span>