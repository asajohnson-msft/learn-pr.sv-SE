<span data-ttu-id="9f83b-101">Vi har installerat vår anpassade programvara, konfigurerat en FTP-server och konfigurerat den virtuella datorn för att ta emot våra videofiler.</span><span class="sxs-lookup"><span data-stu-id="9f83b-101">We've installed our custom software, set up an FTP server, and configured the VM to receive our video files.</span></span> <span data-ttu-id="9f83b-102">Men om vi försöker ansluta till vår offentliga IP-adress med FTP kommer vi att märka att den är blockerad.</span><span class="sxs-lookup"><span data-stu-id="9f83b-102">However, if we try to connect to our public IP address with FTP, we'll find that it's blocked.</span></span> 

<span data-ttu-id="9f83b-103">Justeringar i serverkonfigurationen utförs ofta med utrustning i din lokala miljö.</span><span class="sxs-lookup"><span data-stu-id="9f83b-103">Making adjustments to server configuration is commonly performed with equipment in your on-premises environment.</span></span> <span data-ttu-id="9f83b-104">I det avseendet kan du se virtuella Azure-datorer som en förlängning av den här miljön.</span><span class="sxs-lookup"><span data-stu-id="9f83b-104">In this sense, you can consider Azure VMs to be an extension of that environment.</span></span> <span data-ttu-id="9f83b-105">Du kan göra konfigurationsändringar, hantera nätverk, öppna eller blockera trafik och mycket mer via Azure Portal, Azure CLI eller Azure PowerShell.</span><span class="sxs-lookup"><span data-stu-id="9f83b-105">You can make configuration changes, manage networks, open or block traffic, and more through the Azure portal, Azure CLI, or Azure PowerShell tools.</span></span>

<span data-ttu-id="9f83b-106">Du har redan sett några av de grundläggande informations- och hanteringsalternativen på panelen **Översikt** för den virtuella datorn.</span><span class="sxs-lookup"><span data-stu-id="9f83b-106">You've already seen some of the basic information and management options in the **Overview** panel for the virtual machine.</span></span> <span data-ttu-id="9f83b-107">Nu ska vi titta närmare på nätverkskonfigurationen.</span><span class="sxs-lookup"><span data-stu-id="9f83b-107">Let's explore network configuration a bit more.</span></span>

## <a name="opening-ports-in-azure-vms"></a><span data-ttu-id="9f83b-108">Öppna portar i virtuella Azure-datorer</span><span class="sxs-lookup"><span data-stu-id="9f83b-108">Opening ports in Azure VMs</span></span>

<!-- TODO: Azure portal is inconsistent here in applying the NSG.
By default, new VMs are locked down. 

Apps can make outgoing requests, but the only inbound traffic allowed is from the virtual network (e.g. other resources on the same local network), and from Azure's Load Balancer (probe checks). -->

<span data-ttu-id="9f83b-109">Två steg krävs för att ändra konfigurationen och ge stöd för FTP.</span><span class="sxs-lookup"><span data-stu-id="9f83b-109">There are two steps to adjusting the configuration to support FTP.</span></span> <span data-ttu-id="9f83b-110">När du skapar en ny virtuell dator har du möjlighet att öppna några vanliga portar (RDP, HTTP, HTTPS och SSH).</span><span class="sxs-lookup"><span data-stu-id="9f83b-110">When you create a new VM you have an opportunity to open a few common ports (RDP, HTTP, HTTPS, and SSH).</span></span> <span data-ttu-id="9f83b-111">Om du behöver göra andra ändringar i brandväggen måste du dock göra dem själv.</span><span class="sxs-lookup"><span data-stu-id="9f83b-111">However, if you require other changes to the firewall, you will need to do them yourself.</span></span>

<span data-ttu-id="9f83b-112">Processen för det här omfattar två steg:</span><span class="sxs-lookup"><span data-stu-id="9f83b-112">The process for this involves two steps:</span></span>

1. <span data-ttu-id="9f83b-113">Skapa en nätverkssäkerhetsgrupp.</span><span class="sxs-lookup"><span data-stu-id="9f83b-113">Create a Network Security Group.</span></span>
2. <span data-ttu-id="9f83b-114">Skapa en inkommande regel som tillåter trafik på port 20 och 21 för aktivt FTP-stöd.</span><span class="sxs-lookup"><span data-stu-id="9f83b-114">Create an inbound rule allowing traffic on port 20 and 21 for active FTP support.</span></span>

### <a name="what-is-a-network-security-group"></a><span data-ttu-id="9f83b-115">Vad är en nätverkssäkerhetsgrupp?</span><span class="sxs-lookup"><span data-stu-id="9f83b-115">What is a Network Security Group?</span></span>

<span data-ttu-id="9f83b-116">Virtuella nätverk är grunden för Azure-nätverksmodellen och ger isolering och skydd.</span><span class="sxs-lookup"><span data-stu-id="9f83b-116">Virtual networks (VNets) are the foundation of the Azure networking model and provide isolation and protection.</span></span> <span data-ttu-id="9f83b-117">Nätverkssäkerhetsgrupper (NSG) är det huvudsakliga verktyget för att tillämpa och styra regler för nätverkstrafik på nätverksnivå.</span><span class="sxs-lookup"><span data-stu-id="9f83b-117">Network Security Groups (NSGs) are the main tool you use to enforce and control network traffic rules at the networking level.</span></span> <span data-ttu-id="9f83b-118">NSG:er är ett valfritt säkerhetslager som tillhandahåller en programvarubrandvägg genom att filtrera inkommande och utgående trafik på det virtuella nätverket.</span><span class="sxs-lookup"><span data-stu-id="9f83b-118">NSGs are an optional security layer that provides a software firewall by filtering inbound and outbound traffic on the VNet.</span></span> 

<span data-ttu-id="9f83b-119">Säkerhetsgrupper kan kopplas till ett nätverksgränssnitt (för regler per värd), ett undernät i det virtuella nätverket (om du vill tillämpa på flera resurser) eller båda nivåerna.</span><span class="sxs-lookup"><span data-stu-id="9f83b-119">Security groups can be associated to a network interface (for per-host rules), a subnet in the virtual network (to apply to multiple resources), or both levels.</span></span> 

#### <a name="security-group-rules"></a><span data-ttu-id="9f83b-120">Regler för säkerhetsgrupper</span><span class="sxs-lookup"><span data-stu-id="9f83b-120">Security group rules</span></span>

<span data-ttu-id="9f83b-121">NGS:er använder _regler_ för att tillåta eller neka trafik genom nätverket.</span><span class="sxs-lookup"><span data-stu-id="9f83b-121">NGSs use _rules_ to allow or deny traffic moving through the network.</span></span> <span data-ttu-id="9f83b-122">Varje regeln identifierar käll- och måladress (eller intervall), protokoll, port (eller intervall), riktning (inkommande eller utgående), en numerisk prioritet och om trafiken som matchar regeln ska tillåtas eller nekas.</span><span class="sxs-lookup"><span data-stu-id="9f83b-122">Each rule identifies the source and destination address (or range), protocol, port (or range), direction (inbound or outbound), a numeric priority, and whether to allow or deny the traffic that matches the rule.</span></span> <span data-ttu-id="9f83b-123">Följande bild visar NSG-regler som tillämpas på nivåerna för undernät och gränssnitt.</span><span class="sxs-lookup"><span data-stu-id="9f83b-123">The following illustration shows NSG rules applied at the subnet and network interface levels.</span></span>

![En bild som visar nätverkssäkerhetsgrupper arkitektur i två olika undernät.](../media/7-nsg-rules.png)

<span data-ttu-id="9f83b-127">Varje säkerhetsgrupp har en uppsättning standardsäkerhetsregler för att tillämpa standardnätverksregler som beskrivs ovan.</span><span class="sxs-lookup"><span data-stu-id="9f83b-127">Each security group has a set of default security rules to apply the default network rules described above.</span></span> <span data-ttu-id="9f83b-128">Dessa standardregler kan inte ändras men de _kan_ åsidosättas.</span><span class="sxs-lookup"><span data-stu-id="9f83b-128">These default rules cannot be modified, but _can_ be overridden.</span></span>

#### <a name="how-azure-uses-network-rules"></a><span data-ttu-id="9f83b-129">Så använder Azure nätverksregler</span><span class="sxs-lookup"><span data-stu-id="9f83b-129">How Azure uses network rules</span></span>

<span data-ttu-id="9f83b-130">För inkommande trafik bearbetar Azure den säkerhetsgrupp som är associerad med undernätet först, och sedan den säkerhetsgrupp som är kopplad till nätverksgränssnittet.</span><span class="sxs-lookup"><span data-stu-id="9f83b-130">For inbound traffic, Azure processes the security group associated to the subnet, then the security group applied to the network interface.</span></span> <span data-ttu-id="9f83b-131">Utgående trafik bearbetas i omvänd ordning (nätverksgränssnittet först, sedan undernätet).</span><span class="sxs-lookup"><span data-stu-id="9f83b-131">Outbound traffic is processed in the opposite order (the network interface first, followed by the subnet).</span></span>

> [!WARNING]
> <span data-ttu-id="9f83b-132">Tänk på att säkerhetsgrupper är valfria på båda nivåerna.</span><span class="sxs-lookup"><span data-stu-id="9f83b-132">Keep in mind that security groups are optional at both levels.</span></span> <span data-ttu-id="9f83b-133">Om ingen säkerhetsgrupp tillämpas **tillåts all trafik** av Azure.</span><span class="sxs-lookup"><span data-stu-id="9f83b-133">If no security group is applied then **all traffic is allowed** by Azure.</span></span> <span data-ttu-id="9f83b-134">Om den virtuella datorn har en offentlig IP-adress kan detta utgöra en allvarlig risk, särskilt om operativsystemet inte har någon brandvägg.</span><span class="sxs-lookup"><span data-stu-id="9f83b-134">If the VM has a public IP, this could be a serious risk particularly if the OS doesn't provide some sort of firewall.</span></span>

<span data-ttu-id="9f83b-135">Reglerna utvärderas i _prioritetsordning_, från regeln med **lägst prioritet**.</span><span class="sxs-lookup"><span data-stu-id="9f83b-135">The rules are evaluated in _priority-order_, starting with the **lowest priority** rule.</span></span> <span data-ttu-id="9f83b-136">Neka-regler **stoppar** alltid utvärderingen.</span><span class="sxs-lookup"><span data-stu-id="9f83b-136">Deny rules always **stop** the evaluation.</span></span> <span data-ttu-id="9f83b-137">Om en utgående begäran exempelvis blockeras av en regel för nätverksgränssnittet kontrolleras inte eventuella regler som tillämpas på undernätet.</span><span class="sxs-lookup"><span data-stu-id="9f83b-137">For example, if an outbound request is blocked by a network interface rule, any rules applied to the subnet will not be checked.</span></span> <span data-ttu-id="9f83b-138">För att trafik ska släppas genom säkerhetsgruppen måste den passera _alla_ grupper som tillämpas.</span><span class="sxs-lookup"><span data-stu-id="9f83b-138">In order for traffic to be allowed through the security group, it must pass through _all_ applied groups.</span></span>

<span data-ttu-id="9f83b-139">Den sista regeln är alltid **Neka alla**.</span><span class="sxs-lookup"><span data-stu-id="9f83b-139">The last rule is always a **Deny All** rule.</span></span> <span data-ttu-id="9f83b-140">Det här är en standardregel som läggs till i varje säkerhetsgrupp för både inkommande och utgående trafik med prioriteten 65500.</span><span class="sxs-lookup"><span data-stu-id="9f83b-140">This is a default rule added to every security group for both inbound and outbound traffic with a priority of 65500.</span></span> <span data-ttu-id="9f83b-141">För att trafik ska släppas genom säkerhetsgruppen _måste du därför definiera en regel av typen ”Tillåt”_. Annars blockeras trafiken av den sista standardregeln.</span><span class="sxs-lookup"><span data-stu-id="9f83b-141">That means to have traffic pass through the security group _you must have an allow rule_ or it will be blocked by the default final rule.</span></span>

> [!NOTE]
> <span data-ttu-id="9f83b-142">SMTP (port 25) är ett specialfall – beroende på din prenumerationsnivå och när ditt konto har skapats kan utgående SMTP-trafik blockeras.</span><span class="sxs-lookup"><span data-stu-id="9f83b-142">SMTP (port 25) is a special case, depending on your subscription level and when your account was created, outbound SMTP traffic may be blocked.</span></span> <span data-ttu-id="9f83b-143">Du kan begära att få begränsningen borttagen genom att skicka in en affärsrelaterad motivering.</span><span class="sxs-lookup"><span data-stu-id="9f83b-143">You can make a request to remove this restriction with business justification.</span></span>

<span data-ttu-id="9f83b-144">Eftersom vi inte har skapat en säkerhetsgrupp för den här virtuella datorn ska vi göra det och tillämpa den.</span><span class="sxs-lookup"><span data-stu-id="9f83b-144">Since we didn't create a security group for this VM, let's do that and apply it.</span></span>

## <a name="creating-network-security-groups"></a><span data-ttu-id="9f83b-145">Skapa nätverkssäkerhetsgrupper</span><span class="sxs-lookup"><span data-stu-id="9f83b-145">Creating Network Security Groups</span></span>

<span data-ttu-id="9f83b-146">Som det mesta i Azure är säkerhetsgrupper hanterade resurser. Du kan skapa dem på Azure Portal eller med det kommandoradsbaserade skriptverktyget.</span><span class="sxs-lookup"><span data-stu-id="9f83b-146">Security groups are managed resources like most everything in Azure, you can create them in the Azure portal or through command-line scripting tools.</span></span> <span data-ttu-id="9f83b-147">Utmaningen är att definiera reglerna.</span><span class="sxs-lookup"><span data-stu-id="9f83b-147">The challenge is in defining the rules.</span></span> <span data-ttu-id="9f83b-148">Nu ska vi se hur du skapar en ny regel för att tillåta FTP-åtkomst.</span><span class="sxs-lookup"><span data-stu-id="9f83b-148">Let's look at defining a new rule to allow FTP access.</span></span>