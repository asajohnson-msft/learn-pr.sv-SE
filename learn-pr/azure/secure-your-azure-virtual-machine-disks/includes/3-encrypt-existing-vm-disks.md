<span data-ttu-id="ed0d4-101">Anta att ditt företag har beslutat att implementera Azure Disk Encryption (ADE) för alla virtuella datorer.</span><span class="sxs-lookup"><span data-stu-id="ed0d4-101">Suppose your company has decided to implement Azure Disk Encryption (ADE) across all VMs.</span></span> <span data-ttu-id="ed0d4-102">Du behöver utvärdera hur du distribuerar kryptering till befintliga virtuella datorvolymer.</span><span class="sxs-lookup"><span data-stu-id="ed0d4-102">You need to evaluate how to roll out encryption to existing VM volumes.</span></span>

<span data-ttu-id="ed0d4-103">Här ska vi titta på kraven för ADE och de steg som behövs för att kryptera diskar på befintliga virtuella Windows-datorer.</span><span class="sxs-lookup"><span data-stu-id="ed0d4-103">Here, we'll look at the requirements for ADE, and the steps involved in encrypting disks on existing Windows VMs.</span></span>

## <a name="azure-disk-encryption-prerequisites"></a><span data-ttu-id="ed0d4-104">Förhandskrav för Azure Disk Encryption</span><span class="sxs-lookup"><span data-stu-id="ed0d4-104">Azure Disk Encryption Prerequisites</span></span>

<span data-ttu-id="ed0d4-105">Innan du kan kryptera din första virtuella datordisk så måste du</span><span class="sxs-lookup"><span data-stu-id="ed0d4-105">Before you can encrypt your first VM disk, you need to</span></span>

1. <span data-ttu-id="ed0d4-106">Skapa ett nyckelvalv</span><span class="sxs-lookup"><span data-stu-id="ed0d4-106">Create a key vault</span></span>
1. <span data-ttu-id="ed0d4-107">Konfigurerar ett Azure AD-program och tjänstens huvudnamn</span><span class="sxs-lookup"><span data-stu-id="ed0d4-107">Set up an Azure AD application and service principal</span></span>
1. <span data-ttu-id="ed0d4-108">Ange nyckelvalvets åtkomstprincip för Azure AD-appen</span><span class="sxs-lookup"><span data-stu-id="ed0d4-108">Set the key vault access policy for the Azure AD app</span></span>
1. <span data-ttu-id="ed0d4-109">Ställa in avancerade åtkomstprinciper för nyckelvalvet</span><span class="sxs-lookup"><span data-stu-id="ed0d4-109">Set key vault advanced access policies</span></span>

### <a name="azure-key-vault"></a><span data-ttu-id="ed0d4-110">Azure Key Vault</span><span class="sxs-lookup"><span data-stu-id="ed0d4-110">Azure Key Vault</span></span>

<span data-ttu-id="ed0d4-111">De krypteringsnycklar som används av ADE kan lagras i ett Azure Key Vault.</span><span class="sxs-lookup"><span data-stu-id="ed0d4-111">The encryption keys used by ADE can be stored in an Azure Key Vault.</span></span> <span data-ttu-id="ed0d4-112">Azure Key Vault är ett verktyg för att lagra och komma åt hemligheter på ett säkert sätt.</span><span class="sxs-lookup"><span data-stu-id="ed0d4-112">Azure Key Vault is a tool for securely storing and accessing secrets.</span></span> <span data-ttu-id="ed0d4-113">En hemlighet är något som du vill begränsa åtkomst till, till exempel API-nycklar, lösenord eller certifikat.</span><span class="sxs-lookup"><span data-stu-id="ed0d4-113">A secret is anything that you want to tightly control access to, such as API keys, passwords, or certificates.</span></span> <span data-ttu-id="ed0d4-114">Det ger högt tillgänglig och skalbar och säker lagring i FIPS (Federal Information Processing Standards) 140-2 nivå 2-verifierade Maskinvarusäkerhetsmoduler (HSM).</span><span class="sxs-lookup"><span data-stu-id="ed0d4-114">This provides highly available and scalable secure storage in Federal Information Processing Standards (FIPS) 140-2 Level 2 validated Hardware Security Modules (HSMs).</span></span> <span data-ttu-id="ed0d4-115">Med Key Vault kan du behålla fullständig kontroll över de nycklar som används för att kryptera dina data och du kan hantera och granska din nyckelanvändning.</span><span class="sxs-lookup"><span data-stu-id="ed0d4-115">Using Key Vault, you keep full control of the keys used to encrypt your data, and you can manage and audit your key usage.</span></span> <span data-ttu-id="ed0d4-116">Du kan konfigurera och hantera ditt nyckelvalv med Azure-portalen, Azure PowerShell och Azure CLI.</span><span class="sxs-lookup"><span data-stu-id="ed0d4-116">You can configure and manage your key vault using the Azure portal, Azure PowerShell, and Azure CLI.</span></span>

>[!NOTE]
> <span data-ttu-id="ed0d4-117">Azure Disk Encryption kräver att ditt Nyckelvalv och dina virtuella datorer finns i samma Azure-region. Det säkerställer att krypteringshemligheter inte korsar regionala gränser.</span><span class="sxs-lookup"><span data-stu-id="ed0d4-117">Azure Disk Encryption requires that your Key Vault and your VMs are in the same Azure region; this ensures that encryption secrets do not cross regional boundaries.</span></span>

### <a name="azure-ad-application-and-service-principal"></a><span data-ttu-id="ed0d4-118">Azure AD-program och tjänstens huvudnamn</span><span class="sxs-lookup"><span data-stu-id="ed0d4-118">Azure AD application and service principal</span></span>

<span data-ttu-id="ed0d4-119">För att få åtkomst till eller ändra resurser, exempelvis krypteringskonfigurationen för en virtuell dator med skript eller kod så måste du först ställa in ett **Azure Active Directory-program (AD)**.</span><span class="sxs-lookup"><span data-stu-id="ed0d4-119">To access or modify resources, such as the encryption configuration for a VM with scripts or code, you must first set up an **Azure Active Directory (AD) application**.</span></span> <span data-ttu-id="ed0d4-120">Azure Active Directory (Azure AD) är en molnbaserad katalogtjänst för identitetshantering för flera innehavare som kombinerar viktiga katalogtjänster, åtkomsthantering för program och identitetsskydd i en och samma lösning.</span><span class="sxs-lookup"><span data-stu-id="ed0d4-120">Azure Active Directory (Azure AD) is a multi-tenant, cloud-based directory, and identity management service that combines core directory services, application access management, and identity protection into a single solution.</span></span>

<span data-ttu-id="ed0d4-121">Du behöver också en Azure **tjänsts huvudnamn**.</span><span class="sxs-lookup"><span data-stu-id="ed0d4-121">You'll also need an Azure **service principal**.</span></span> <span data-ttu-id="ed0d4-122">Tjänstens huvudnamn är tjänstkonton du använder för att köra skript eller kod så att du kan tilldela särskilda behörigheter och omfattningar som behövs för att köra uppgiften mot en viss Azure-resurs.</span><span class="sxs-lookup"><span data-stu-id="ed0d4-122">Service principals are the service accounts you use to run the script or code, and allow you to assign the specific permissions and scope that are needed to run the task against a particular Azure resource.</span></span>

<span data-ttu-id="ed0d4-123">Det finns två element i Azure AD. Programobjektet är **_definitionen_** av programmet (vad det gör) och tjänstens huvudnamn är den **_specifika instansen_** av programmet.</span><span class="sxs-lookup"><span data-stu-id="ed0d4-123">There are two elements in Azure AD; the application object is the **_definition_** of the application (what it does), and the service principal is the **_specific instance_** of the application.</span></span>

<span data-ttu-id="ed0d4-124">Den här metoden överensstämmer med principen om **lägsta behörighet** där de behörigheter som tilldelats appen är begränsade till det minsta som krävs för att appen ska kunna utföra sina uppgifter.</span><span class="sxs-lookup"><span data-stu-id="ed0d4-124">This approach aligns with the principle of **least privilege**, where the permissions assigned to the app are restricted to the bare minimum required to enable the app to perform its tasks.</span></span>

<span data-ttu-id="ed0d4-125">Du kan konfigurera och hantera Azure AD-program och tjänstens huvudnamn med Azure-portalen, Azure PowerShell och Azure CLI.</span><span class="sxs-lookup"><span data-stu-id="ed0d4-125">You can configure and manage Azure AD applications and service principals using the Azure portal, Azure PowerShell, and Azure CLI.</span></span>

### <a name="key-vault-access-policies"></a><span data-ttu-id="ed0d4-126">Åtkomstprinciper för nyckelvalvet</span><span class="sxs-lookup"><span data-stu-id="ed0d4-126">Key vault access policies</span></span>

<span data-ttu-id="ed0d4-127">Innan du kan lagra krypteringsnycklar i Key Vault, kräver ADE information om det **klient-ID** och den **Klienthemlighet** för Azure Active Directory-programmet som har behörighet att skriva till Key Vault.</span><span class="sxs-lookup"><span data-stu-id="ed0d4-127">Before you can store encryption keys in a Key Vault, ADE requires details on the **Client ID** and the **Client Secret** of the Azure Active Directory application that is permitted to write to the Key Vault.</span></span>

<span data-ttu-id="ed0d4-128">Du behöver också ge Azure åtkomst till krypteringsnycklarna i ditt nyckelvalv så att de görs tillgängliga för den virtuella datorn för start och dekryptering av volymerna.</span><span class="sxs-lookup"><span data-stu-id="ed0d4-128">You'll also need to provide Azure access to the encryption keys in your key vault, so they are made available to the VM for booting and decrypting the volumes.</span></span>

## <a name="set-key-vault-advanced-access-policies"></a><span data-ttu-id="ed0d4-129">Ställa in avancerade åtkomstprinciper för nyckelvalvet</span><span class="sxs-lookup"><span data-stu-id="ed0d4-129">Set key vault advanced access policies</span></span>

<span data-ttu-id="ed0d4-130">**Avancerade åtkomstprinciper** aktivera diskkryptering på nyckelvalvet och utan dem så kommer krypteringsdistributioner att misslyckas.</span><span class="sxs-lookup"><span data-stu-id="ed0d4-130">**Advanced access policies** enable disk encryption on the key vault, and without them, encryption deployments will fail.</span></span> 

<span data-ttu-id="ed0d4-131">Det finns tre principer som måste aktiveras:</span><span class="sxs-lookup"><span data-stu-id="ed0d4-131">There are three policies that need to be enabled:</span></span>

- <span data-ttu-id="ed0d4-132">**Key Vault för diskkryptering** krävs för Azure Disk Encryption.</span><span class="sxs-lookup"><span data-stu-id="ed0d4-132">**Key Vault for disk encryption** Required for Azure Disk encryption.</span></span>
- <span data-ttu-id="ed0d4-133">**Key Vault för distribution av** låter Microsoft.Compute-resursprovidern hämta hemligheter från nyckelvalvet. Den här principen behövs när du skapar en virtuell dator.</span><span class="sxs-lookup"><span data-stu-id="ed0d4-133">**Key Vault for deployment** Enables the Microsoft.Compute resource provider to retrieve secrets from the key vault; this policy is needed when creating a VM.</span></span>
- <span data-ttu-id="ed0d4-134">**Key Vault för malldistribution, vid behov** låter Azure Resource Manager hämta hemligheter från nyckelvalvet. Den här principen är obligatorisk när du använder ARM-mallar för distribution av virtuella datorer.</span><span class="sxs-lookup"><span data-stu-id="ed0d4-134">**Key Vault for template deployment, if needed** Enables Azure Resource Manager to get secrets from the key vault; this policy is required when using ARM templates for VM deployment.</span></span>

<span data-ttu-id="ed0d4-135">Nyckelvalvets åtkomstprinciper kan konfigureras och hanteras med hjälp av Azure-portalen, Azure PowerShell eller Azure CLI.</span><span class="sxs-lookup"><span data-stu-id="ed0d4-135">Key vault access policies can be configured and managed using the Azure portal, Azure PowerShell, or the Azure CLI.</span></span>

### <a name="what-is-the-azure-disk-encryption-prerequisites-configuration-script"></a><span data-ttu-id="ed0d4-136">Vad är förhandskonfigurationsskriptet för Azure Disk Encryption</span><span class="sxs-lookup"><span data-stu-id="ed0d4-136">What is the Azure Disk Encryption Prerequisites Configuration Script</span></span>

<span data-ttu-id="ed0d4-137">**Förhandskonfigurationsskriptet för Azure Disk Encryption** konfigurerar alla (eller så många du vill) av förhandskraven för kryptering.</span><span class="sxs-lookup"><span data-stu-id="ed0d4-137">The **Azure Disk Encryption Prerequisites Configuration Script** sets up all (or as many as you want) of the encryption prerequisites.</span></span> <span data-ttu-id="ed0d4-138">Skriptet ser även till att ditt Key Vault befinner sig i samma region som den virtuella datorn du ska kryptera.</span><span class="sxs-lookup"><span data-stu-id="ed0d4-138">The script also ensures that your Key Vault is in the same region as the VM you are going to encrypt.</span></span> <span data-ttu-id="ed0d4-139">Det skapar en resursgrupp, ett nyckelvalv och anger nyckelvalvets åtkomstprincip.</span><span class="sxs-lookup"><span data-stu-id="ed0d4-139">It will create a resource group, a key vault, and set the key vault access policy.</span></span> <span data-ttu-id="ed0d4-140">Skriptet skapar även ett resurslås på nyckelvalvet för att skydda det mot oavsiktlig borttagning.</span><span class="sxs-lookup"><span data-stu-id="ed0d4-140">The script also creates a resource lock on the key vault to help protect it from accidental deletion.</span></span>

## <a name="encrypting-an-existing-vm-disk"></a><span data-ttu-id="ed0d4-141">Kryptera en befintlig virtuell datordisk</span><span class="sxs-lookup"><span data-stu-id="ed0d4-141">Encrypting an existing VM disk</span></span>

<span data-ttu-id="ed0d4-142">Det finns två steg för att kryptera en befintlig virtuell datordisk när du använder **förhandskonfigurationsskriptet för Azure Disk Encryption**:</span><span class="sxs-lookup"><span data-stu-id="ed0d4-142">There are two steps for encrypting an existing VM disk, when using the **Azure Disk Encryption Prerequisites Configuration Script**:</span></span>

1. <span data-ttu-id="ed0d4-143">Kör förhandskonfigurationsskriptet för Azure Disk Encryption.</span><span class="sxs-lookup"><span data-stu-id="ed0d4-143">Run the Azure disk encryption prerequisites configuration script.</span></span>
1. <span data-ttu-id="ed0d4-144">Kryptera den virtuella Azure-datorn i PowerShell</span><span class="sxs-lookup"><span data-stu-id="ed0d4-144">Encrypt the Azure virtual machine in PowerShell</span></span>
