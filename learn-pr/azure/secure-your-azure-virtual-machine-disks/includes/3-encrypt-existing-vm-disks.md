<span data-ttu-id="7d46b-101">Anta att ditt företag har beslutat att implementera Azure Disk Encryption (ADE) för alla virtuella datorer.</span><span class="sxs-lookup"><span data-stu-id="7d46b-101">Suppose your company has decided to implement Azure Disk Encryption (ADE) across all VMs.</span></span> <span data-ttu-id="7d46b-102">Du behöver utvärdera hur du distribuerar kryptering till befintliga virtuella datorvolymer.</span><span class="sxs-lookup"><span data-stu-id="7d46b-102">You need to evaluate how to roll out encryption to existing VM volumes.</span></span>

<span data-ttu-id="7d46b-103">Här ska vi titta på kraven för ADE och de steg som behövs för att kryptera diskar på befintliga virtuella Windows-datorer.</span><span class="sxs-lookup"><span data-stu-id="7d46b-103">Here, we'll look at the requirements for ADE, and the steps involved in encrypting disks on existing Windows VMs.</span></span>

## <a name="azure-disk-encryption-prerequisites"></a><span data-ttu-id="7d46b-104">Förhandskrav för Azure Disk Encryption</span><span class="sxs-lookup"><span data-stu-id="7d46b-104">Azure Disk Encryption prerequisites</span></span>

<span data-ttu-id="7d46b-105">Innan du kan kryptera din första virtuella datordisk så måste du göra följande:</span><span class="sxs-lookup"><span data-stu-id="7d46b-105">Before you can encrypt your first VM disk, you need to:</span></span>

1. <span data-ttu-id="7d46b-106">Skapa ett nyckelvalv</span><span class="sxs-lookup"><span data-stu-id="7d46b-106">Create a key vault.</span></span>
1. <span data-ttu-id="7d46b-107">Konfigurera ett Azure AD-program (Microsoft Azure Active Directory) samt ange tjänstens huvudnamn</span><span class="sxs-lookup"><span data-stu-id="7d46b-107">Set up an Azure Active Directory (Azure AD) application and service principal.</span></span>
1. <span data-ttu-id="7d46b-108">Ange nyckelvalvets åtkomstprincip för Azure AD-appen</span><span class="sxs-lookup"><span data-stu-id="7d46b-108">Set the key vault access policy for the Azure AD app.</span></span>
1. <span data-ttu-id="7d46b-109">Ställa in avancerade åtkomstprinciper för nyckelvalvet</span><span class="sxs-lookup"><span data-stu-id="7d46b-109">Set key vault advanced access policies.</span></span>

### <a name="azure-key-vault"></a><span data-ttu-id="7d46b-110">Azure Key Vault</span><span class="sxs-lookup"><span data-stu-id="7d46b-110">Azure Key Vault</span></span>

<span data-ttu-id="7d46b-111">De krypteringsnycklar som används av ADE kan lagras i ett Azure Key Vault.</span><span class="sxs-lookup"><span data-stu-id="7d46b-111">The encryption keys used by ADE can be stored in Azure Key Vault.</span></span> <span data-ttu-id="7d46b-112">Azure Key Vault är ett verktyg för att lagra och komma åt hemligheter på ett säkert sätt.</span><span class="sxs-lookup"><span data-stu-id="7d46b-112">Azure Key Vault is a tool for securely storing and accessing secrets.</span></span> <span data-ttu-id="7d46b-113">En hemlighet är något som du vill begränsa åtkomst till, till exempel API-nycklar, lösenord eller certifikat.</span><span class="sxs-lookup"><span data-stu-id="7d46b-113">A secret is anything that you want to tightly control access to, such as API keys, passwords, or certificates.</span></span> <span data-ttu-id="7d46b-114">Det ger högst tillgänglig, skalbar och säker lagring i FIPS (Federal Information Processing Standards) 140-2 nivå 2-verifierade Maskinvarusäkerhetsmoduler (HSM).</span><span class="sxs-lookup"><span data-stu-id="7d46b-114">This provides highly available and scalable secure storage, in Federal Information Processing Standards (FIPS) 140-2 Level 2 validated Hardware Security Modules (HSMs).</span></span> <span data-ttu-id="7d46b-115">Med Key Vault kan du behålla fullständig kontroll över de nycklar som används för att kryptera dina data, och även hantera och granska din nyckelanvändning.</span><span class="sxs-lookup"><span data-stu-id="7d46b-115">Using Key Vault, you keep full control of the keys used to encrypt your data, and you can manage and audit your key usage.</span></span> <span data-ttu-id="7d46b-116">Du kan konfigurera och hantera ditt nyckelvalv via Microsoft Azure-portalen, Azure PowerShell och Azure CLI.</span><span class="sxs-lookup"><span data-stu-id="7d46b-116">You can configure and manage your key vault using the Azure portal, Azure PowerShell, and the Azure CLI.</span></span>

>[!NOTE]
> <span data-ttu-id="7d46b-117">Azure Disk Encryption kräver att ditt nyckelvalv och dina virtuella datorer finns i samma Azure-region. Det säkerställer att krypteringshemligheter inte korsar regionala gränser.</span><span class="sxs-lookup"><span data-stu-id="7d46b-117">Azure Disk Encryption requires that your key vault and your VMs are in the same Azure region; this ensures that encryption secrets do not cross regional boundaries.</span></span>

### <a name="azure-ad-application-and-service-principal"></a><span data-ttu-id="7d46b-118">Azure AD-program och tjänstens huvudnamn</span><span class="sxs-lookup"><span data-stu-id="7d46b-118">Azure AD application and service principal</span></span>

<span data-ttu-id="7d46b-119">För att få åtkomst till eller ändra resurser, exempelvis krypteringskonfigurationen för en virtuell dator med skript eller kod, så måste du först konfigurera ett **Azure Active Directory-program (AD)**.</span><span class="sxs-lookup"><span data-stu-id="7d46b-119">To access or modify resources, such as the encryption configuration for a VM with scripts or code, you must first set up an **Azure Active Directory (AD) application**.</span></span> <span data-ttu-id="7d46b-120">Azure AD är en molnbaserad katalog- och identitetshanteringstjänst för flera klientorganisationer.</span><span class="sxs-lookup"><span data-stu-id="7d46b-120">Azure AD is a multi-tenant, cloud-based directory, and identity management service.</span></span> <span data-ttu-id="7d46b-121">I den kombineras viktiga katalogtjänster, åtkomsthantering för program och identitetsskydd i en enda lösning.</span><span class="sxs-lookup"><span data-stu-id="7d46b-121">It combines core directory services, application access management, and identity protection into a single solution.</span></span>

<span data-ttu-id="7d46b-122">Du behöver också ett **huvudnamn för Azure-tjänsten**.</span><span class="sxs-lookup"><span data-stu-id="7d46b-122">You'll also need an Azure **service principal**.</span></span> <span data-ttu-id="7d46b-123">Huvudnamnen för tjänsten är de tjänstkonton som används för att köra skript eller kod.</span><span class="sxs-lookup"><span data-stu-id="7d46b-123">Service principals are the service accounts you use to run the script or code.</span></span> <span data-ttu-id="7d46b-124">På så sätt kan du tilldela särskilda behörigheter och omfattningar som behövs för att köra en uppgift mot en viss Azure-resurs.</span><span class="sxs-lookup"><span data-stu-id="7d46b-124">They allow you to assign the specific permissions and scope that are needed to run the task against a particular Azure resource.</span></span>

<span data-ttu-id="7d46b-125">Azure AD innehåller två element: programobjektet är en **_definition_** av programmet (vad det gör) och tjänstens huvudnamn är den **_specifika instansen_** av programmet.</span><span class="sxs-lookup"><span data-stu-id="7d46b-125">There are two elements in Azure AD: the application object is the **_definition_** of the application (what it does), and the service principal is the **_specific instance_** of the application.</span></span>

<span data-ttu-id="7d46b-126">Den här metoden överensstämmer med principen om **lägsta behörighet**, där de behörigheter som tilldelats appen begränsas till de lägsta som krävs för att appen ska kunna utföra sina uppgifter.</span><span class="sxs-lookup"><span data-stu-id="7d46b-126">This approach aligns with the principle of **least privilege**, where the permissions assigned to the app are restricted to the bare minimum required to enable the app to perform its tasks.</span></span>

<span data-ttu-id="7d46b-127">Du kan konfigurera och hantera Azure AD-program och tjänstens huvudnamn via Microsoft Azure-portalen, Azure PowerShell och Azure CLI.</span><span class="sxs-lookup"><span data-stu-id="7d46b-127">You can configure and manage Azure AD applications and service principals using the Azure portal, Azure PowerShell, and the Azure CLI.</span></span>

### <a name="key-vault-access-policies"></a><span data-ttu-id="7d46b-128">Åtkomstprinciper för nyckelvalvet</span><span class="sxs-lookup"><span data-stu-id="7d46b-128">Key vault access policies</span></span>

<span data-ttu-id="7d46b-129">Innan du kan lagra krypteringsnycklar i ett nyckelvalv kräver ADE information om det **klient-ID** och den **klienthemlighet** för Azure Active Directory-programmet som har behörighet att skriva till nyckelvalvet.</span><span class="sxs-lookup"><span data-stu-id="7d46b-129">Before you can store encryption keys in a key vault, ADE requires details on the **Client ID** and the **Client Secret** of the Azure AD application that is permitted to write to the key vault.</span></span>

<span data-ttu-id="7d46b-130">Du behöver också ge Azure åtkomst till krypteringsnycklarna i ditt nyckelvalv så att de görs tillgängliga för den virtuella datorn för start och dekryptering av volymerna.</span><span class="sxs-lookup"><span data-stu-id="7d46b-130">You'll also need to provide Azure access to the encryption keys in your key vault, so they are made available to the VM for booting and decrypting the volumes.</span></span>

## <a name="set-key-vault-advanced-access-policies"></a><span data-ttu-id="7d46b-131">Ställa in avancerade åtkomstprinciper för nyckelvalvet</span><span class="sxs-lookup"><span data-stu-id="7d46b-131">Set key vault advanced access policies</span></span>

<span data-ttu-id="7d46b-132">**Avancerade åtkomstprinciper** aktivera diskkryptering på nyckelvalvet och utan dem så kommer krypteringsdistributioner att misslyckas.</span><span class="sxs-lookup"><span data-stu-id="7d46b-132">**Advanced access policies** enable disk encryption on the key vault, and without them, encryption deployments will fail.</span></span> 

<span data-ttu-id="7d46b-133">Det finns tre principer som måste aktiveras:</span><span class="sxs-lookup"><span data-stu-id="7d46b-133">There are three policies that need to be enabled:</span></span>

- <span data-ttu-id="7d46b-134">**Key Vault för diskkryptering**.</span><span class="sxs-lookup"><span data-stu-id="7d46b-134">**Key Vault for disk encryption**.</span></span> <span data-ttu-id="7d46b-135">Krävs för Azure Disk Encryption.</span><span class="sxs-lookup"><span data-stu-id="7d46b-135">Required for Azure Disk Encryption.</span></span>
- <span data-ttu-id="7d46b-136">**Key Vault för distribution**.</span><span class="sxs-lookup"><span data-stu-id="7d46b-136">**Key Vault for deployment**.</span></span> <span data-ttu-id="7d46b-137">Ger resursleverantören Microsoft.Compute behörighet att hämta hemligheter från nyckelvalvet.</span><span class="sxs-lookup"><span data-stu-id="7d46b-137">Enables the Microsoft.Compute resource provider to retrieve secrets from the key vault.</span></span> <span data-ttu-id="7d46b-138">Den här principen behövs när du skapar en virtuell dator.</span><span class="sxs-lookup"><span data-stu-id="7d46b-138">This policy is needed when you are creating a VM.</span></span>
- <span data-ttu-id="7d46b-139">**Key Vault för malldistribution, om sådan behövs**.</span><span class="sxs-lookup"><span data-stu-id="7d46b-139">**Key Vault for template deployment, if needed**.</span></span> <span data-ttu-id="7d46b-140">Ger Azure Resource Manager behörighet att hämta hemligheter från nyckelvalvet.</span><span class="sxs-lookup"><span data-stu-id="7d46b-140">Enables Azure Resource Manager to get secrets from the key vault.</span></span> <span data-ttu-id="7d46b-141">Den här principen behövs när du använder Azure Resource Manager-mallar för distribution av virtuella datorer.</span><span class="sxs-lookup"><span data-stu-id="7d46b-141">This policy is required when you are using Azure Resource Manager templates for VM deployment.</span></span>

<span data-ttu-id="7d46b-142">Nyckelvalvets åtkomstprinciper kan konfigureras och hanteras via Microsoft Azure-portalen, Azure PowerShell eller Azure CLI.</span><span class="sxs-lookup"><span data-stu-id="7d46b-142">Key vault access policies can be configured and managed using the Azure portal, Azure PowerShell, or the Azure CLI.</span></span>

### <a name="what-is-the-azure-disk-encryption-prerequisites-configuration-script"></a><span data-ttu-id="7d46b-143">Vad är förhandskonfigurationsskriptet för Azure Disk Encryption?</span><span class="sxs-lookup"><span data-stu-id="7d46b-143">What is the Azure Disk Encryption prerequisites configuration script</span></span>

<span data-ttu-id="7d46b-144">**Förhandskonfigurationsskriptet för Azure Disk Encryption** konfigurerar alla (eller valfritt antal) förhandskrav för kryptering.</span><span class="sxs-lookup"><span data-stu-id="7d46b-144">The **Azure Disk Encryption prerequisites configuration script** sets up all (or as many as you want) of the encryption prerequisites.</span></span> <span data-ttu-id="7d46b-145">Skriptet ser även till att ditt nyckelvalv befinner sig i samma region som den virtuella datorn du ska kryptera.</span><span class="sxs-lookup"><span data-stu-id="7d46b-145">The script also ensures that your key vault is in the same region as the VM you are going to encrypt.</span></span> <span data-ttu-id="7d46b-146">Det skapar en resursgrupp och ett nyckelvalv, och anger nyckelvalvets åtkomstprincip.</span><span class="sxs-lookup"><span data-stu-id="7d46b-146">It will create a resource group and key vault, and set the key vault access policy.</span></span> <span data-ttu-id="7d46b-147">Skriptet skapar även ett resurslås på nyckelvalvet för att skydda det mot oavsiktlig borttagning.</span><span class="sxs-lookup"><span data-stu-id="7d46b-147">The script also creates a resource lock on the key vault to help protect it from accidental deletion.</span></span>

## <a name="encrypting-an-existing-vm-disk"></a><span data-ttu-id="7d46b-148">Kryptera en befintlig virtuell datordisk</span><span class="sxs-lookup"><span data-stu-id="7d46b-148">Encrypting an existing VM disk</span></span>

<span data-ttu-id="7d46b-149">Det finns två steg du behöver utföra för att kryptera en befintlig virtuell datordisk när du använder förhandskonfigurationsskriptet för Azure Disk Encryption:</span><span class="sxs-lookup"><span data-stu-id="7d46b-149">There are two steps for encrypting an existing VM disk, when you are using the Azure Disk Encryption prerequisites configuration script:</span></span>

1. <span data-ttu-id="7d46b-150">Köra förhandskonfigurationsskriptet för Azure Disk Encryption</span><span class="sxs-lookup"><span data-stu-id="7d46b-150">Run the Azure Disk Encryption prerequisites configuration script.</span></span>
1. <span data-ttu-id="7d46b-151">Kryptera den virtuella Azure-datorn i PowerShell</span><span class="sxs-lookup"><span data-stu-id="7d46b-151">Encrypt the Azure virtual machine in PowerShell.</span></span>
